name: Check Specific PR Coverage
on:
  workflow_dispatch:
    inputs:
      pr_number:
        description: 'PR number to check'
        required: true
        type: number
      upstream_repo:
        description: 'Upstream repository (owner/repo)'
        required: true
        type: string
        default: '567-labs/kura'

jobs:
  check-coverage:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout your fork
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Add upstream remote and fetch PR
        run: |
          git remote add upstream https://github.com/${{ inputs.upstream_repo }}.git
          git fetch upstream pull/${{ inputs.pr_number }}/head:pr-${{ inputs.pr_number }}
          git checkout pr-${{ inputs.pr_number }}
          git fetch upstream main:upstream-main
      
      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          enable-cache: true
      
      - name: Set up Python and install dependencies
        run: |
          uv python install 3.9
          uv sync --all-extras --dev
          uv pip install pytest-cov diff-cover
      
      - name: Run tests with coverage
        run: uv run pytest --cov=kura --cov-report=xml --cov-report=html -v
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY || 'sk-test-dummy-key' }}
          GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY || 'dummy-key' }}
      
      - name: Generate diff coverage reports
        run: |
          uv run diff-cover coverage.xml \
            --compare-branch=upstream-main \
            --format json:diff-coverage.json \
            --format html:diff-coverage.html \
            --format markdown:diff-coverage.md || true
      
      - name: Show results in summary
        run: |
          echo "## ðŸ“Š PR #${{ inputs.pr_number }} Coverage Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          cat diff-coverage.md >> $GITHUB_STEP_SUMMARY 2>/dev/null || echo "Report not available" >> $GITHUB_STEP_SUMMARY
      
      - name: Upload all coverage reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: pr-${{ inputs.pr_number }}-coverage
          path: |
            coverage.xml
            diff-coverage.html
            diff-coverage.json
            diff-coverage.md
            htmlcov/
