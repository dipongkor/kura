name: Check Specific PR Coverage
on:
  workflow_dispatch:
    inputs:
      pr_number:
        description: 'PR number to check'
        required: true
        type: number
      upstream_repo:
        description: 'Upstream repository (owner/repo)'
        required: true
        type: string
        default: '567-labs/kura'
      coverage_threshold:
        description: 'Minimum coverage percentage'
        required: false
        default: '80'
        type: string

jobs:
  check-coverage:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout your fork
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Add upstream remote
        run: |
          git remote add upstream https://github.com/${{ inputs.upstream_repo }}.git
          git remote -v
      
      - name: Fetch PR from upstream
        run: |
          git fetch upstream pull/${{ inputs.pr_number }}/head:pr-${{ inputs.pr_number }}
          git checkout pr-${{ inputs.pr_number }}
      
      - name: Fetch main branch from upstream
        run: git fetch upstream main:upstream-main
      
      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          enable-cache: true
      
      - name: Set up Python
        run: uv python install 3.9
      
      - name: Install the project
        run: uv sync --all-extras --dev
      
      - name: Install coverage tools
        run: uv pip install pytest-cov diff-cover coverage
      
      - name: Run tests with coverage
        run: uv run pytest --cov=kura --cov-report=xml --cov-report=html --cov-report=term -v
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY || 'sk-test-dummy-key-1234567890abcdefghijklmnopqrstuvwxyz' }}
          GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY || 'dummy-google-api-key-for-testing' }}
      
      - name: Verify coverage files
        run: |
          echo "Checking for coverage files..."
          ls -lah coverage.xml htmlcov/ || echo "Some coverage files missing"
      
      - name: Generate diff coverage reports
        run: |
          echo "Generating diff coverage reports..."
          
          # Try to generate all formats at once
          uv run diff-cover coverage.xml \
            --compare-branch=upstream-main \
            --format json:diff-coverage.json \
            --format html:diff-coverage.html \
            --format markdown:diff-coverage.md \
            --fail-under=${{ inputs.coverage_threshold }} 2>&1 | tee diff-cover.log || echo "diff-cover completed with warnings/errors"
          
          # Check what was generated
          echo ""
          echo "Generated files:"
          ls -lah diff-coverage.* 2>/dev/null || echo "No diff-coverage files found"
          
          # Create fallback files if needed
          if [ ! -f diff-coverage.json ]; then
            echo '{"error": "JSON report generation failed", "check": "diff-cover.log"}' > diff-coverage.json
          fi
          
          if [ ! -f diff-coverage.md ]; then
            echo "Markdown report not generated, creating from terminal output..."
            uv run diff-cover coverage.xml --compare-branch=upstream-main > diff-coverage.md 2>&1 || echo "# Diff Coverage Report Generation Failed" > diff-coverage.md
          fi
          
          if [ ! -f diff-coverage.html ]; then
            echo "<html><body><h1>HTML report generation failed</h1></body></html>" > diff-coverage.html
          fi
        continue-on-error: true
      
      - name: Display all generated files
        run: |
          echo "All files in current directory:"
          ls -lah
          echo ""
          echo "Coverage files:"
          ls -lah *.xml *.json *.html *.md htmlcov/ 2>/dev/null || echo "Some files missing"
      
      - name: Display results
        run: |
          echo "## PR #${{ inputs.pr_number }} Coverage Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Upstream Repository:** ${{ inputs.upstream_repo }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -f diff-coverage.md ]; then
            cat diff-coverage.md >> $GITHUB_STEP_SUMMARY
          else
            echo "⚠️ Diff coverage report not generated" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Changed Files:" >> $GITHUB_STEP_SUMMARY
          git diff upstream-main --name-only >> $GITHUB_STEP_SUMMARY
      
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: pr-${{ inputs.pr_number }}-coverage
          path: |
            coverage.xml
            diff-coverage.html
            diff-coverage.json
            diff-coverage.md
            diff-cover.log
            htmlcov/
