name: Check Specific PR Coverage

on:
  workflow_dispatch:
    inputs:
      pr_number:
        description: 'PR number to check'
        required: true
        type: number
      upstream_repo:
        description: 'Upstream repository (owner/repo)'
        required: true
        type: string
        default: '567-labs/kura'  # Replace with actual upstream
      coverage_threshold:
        description: 'Minimum coverage percentage'
        required: false
        default: '80'
        type: string

jobs:
  check-coverage:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout your fork
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Add upstream remote
        run: |
          git remote add upstream https://github.com/${{ inputs.upstream_repo }}.git
          git remote -v
      
      - name: Fetch PR from upstream
        run: |
          git fetch upstream pull/${{ inputs.pr_number }}/head:pr-${{ inputs.pr_number }}
          git checkout pr-${{ inputs.pr_number }}
      
      - name: Fetch main branch from upstream
        run: git fetch upstream main:upstream-main
      
      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          enable-cache: true
      
      - name: Set up Python
        run: uv python install 3.9
      
      - name: Install the project
        run: uv sync --all-extras --dev
      
      - name: Install diff-cover
        run: uv pip install diff-cover
      
      - name: Run tests with coverage
        run: uv run pytest --cov=kura --cov-report=xml --cov-report=term -v
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
      
      - name: Generate diff coverage
        run: |
          uv run diff-cover coverage.xml \
            --compare-branch=upstream-main \
            --fail-under=${{ inputs.coverage_threshold }} \
            --format json:diff-coverage.json \
            --format html:diff-coverage.html \
            --format markdown:diff-coverage.md
      
      - name: Display results
        run: |
          echo "## PR #${{ inputs.pr_number }} Coverage Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Upstream Repository:** ${{ inputs.upstream_repo }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          cat diff-coverage.md >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Changed Files:" >> $GITHUB_STEP_SUMMARY
          git diff upstream-main --name-only >> $GITHUB_STEP_SUMMARY
      
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: pr-${{ inputs.pr_number }}-coverage
          path: |
            coverage.xml
            diff-coverage.html
            diff-coverage.json
            diff-coverage.md
            htmlcov/
